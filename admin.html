<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .tab-active { background: linear-gradient(135deg,#3b82f6,#8b5cf6); color:#fff; }
    .card { transition: all .3s ease; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,.1); }
    .btn { transition: transform .15s ease; }
    .btn:active { transform: scale(.98); }
  </style>
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Topbar -->
  <header class="bg-white shadow sticky top-0 z-30">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-bold">Admin Dashboard</h1>
      <div class="flex gap-2">
        <a href="index.html" class="px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-700 btn">Kembali ke Situs</a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-6" id="tabs">
      <button data-tab="photos" class="px-4 py-2 rounded-lg bg-white shadow btn tab-active">Foto</button>
      <button data-tab="achievements" class="px-4 py-2 rounded-lg bg-white shadow btn">Prestasi</button>
      <button data-tab="projects" class="px-4 py-2 rounded-lg bg-white shadow btn">Karya</button>
      <button data-tab="literacy" class="px-4 py-2 rounded-lg bg-white shadow btn">Literasi</button>
      <button data-tab="education" class="px-4 py-2 rounded-lg bg-white shadow btn">Ruang Murid</button>
      <button data-tab="tahfidz" class="px-4 py-2 rounded-lg bg-white shadow btn">Tahfidz</button>
    </div>

    <!-- Panels -->
    <div id="panels" class="space-y-12">
      <!-- Panel template repeated per collection -->
      <section id="panel-photos" data-collection="photos">
        <h2 class="text-2xl font-semibold mb-3">Kelola Foto</h2>
        <p class="text-gray-600 mb-4">Unggah/hapus foto untuk galeri umum.</p>
        <form class="bg-white p-4 rounded-lg shadow mb-4 grid md:grid-cols-2 gap-4" data-form>
          <div>
            <label class="block text-sm font-medium mb-1">Judul</label>
            <input type="text" name="title" class="w-full border rounded px-3 py-2" placeholder="Judul" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Gambar</label>
            <input type="file" name="image" accept="image/*" class="w-full" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Deskripsi</label>
            <textarea name="description" class="w-full border rounded px-3 py-2" rows="3" placeholder="Deskripsi (opsional)"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-2">
            <button type="reset" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 btn">Reset</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 btn">Upload</button>
          </div>
        </form>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" data-list></div>
      </section>

      <section id="panel-achievements" data-collection="achievements">
        <h2 class="text-2xl font-semibold mb-3">Kelola Prestasi</h2>
        <p class="text-gray-600 mb-4">Prestasi untuk ditampilkan pada bagian Prestasi.</p>
        <form class="bg-white p-4 rounded-lg shadow mb-4 grid md:grid-cols-2 gap-4" data-form>
          <div>
            <label class="block text-sm font-medium mb-1">Judul</label>
            <input type="text" name="title" class="w-full border rounded px-3 py-2" placeholder="Judul" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Tanggal</label>
            <input type="date" name="date" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Gambar (opsional)</label>
            <input type="file" name="image" accept="image/*" class="w-full" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Deskripsi</label>
            <textarea name="description" class="w-full border rounded px-3 py-2" rows="3" placeholder="Deskripsi"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-2">
            <button type="reset" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 btn">Reset</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 btn">Simpan</button>
          </div>
        </form>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" data-list></div>
      </section>

      <section id="panel-projects" data-collection="projects">
        <h2 class="text-2xl font-semibold mb-3">Kelola Karya</h2>
        <p class="text-gray-600 mb-4">Proyek/karya (judul, deskripsi, gambar).</p>
        <form class="bg-white p-4 rounded-lg shadow mb-4 grid md:grid-cols-2 gap-4" data-form>
          <div>
            <label class="block text-sm font-medium mb-1">Judul</label>
            <input type="text" name="title" class="w-full border rounded px-3 py-2" placeholder="Judul" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Gambar (opsional)</label>
            <input type="file" name="image" accept="image/*" class="w-full" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Deskripsi</label>
            <textarea name="description" class="w-full border rounded px-3 py-2" rows="3" placeholder="Deskripsi"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-2">
            <button type="reset" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 btn">Reset</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 btn">Simpan</button>
          </div>
        </form>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" data-list></div>
      </section>

      <section id="panel-literacy" data-collection="literacy">
        <h2 class="text-2xl font-semibold mb-3">Kelola Literasi</h2>
        <p class="text-gray-600 mb-4">Artikel/buku/komik (judul, deskripsi/ringkas, gambar opsional).</p>
        <form class="bg-white p-4 rounded-lg shadow mb-4 grid md:grid-cols-2 gap-4" data-form>
          <div>
            <label class="block text-sm font-medium mb-1">Judul</label>
            <input type="text" name="title" class="w-full border rounded px-3 py-2" placeholder="Judul" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Gambar (opsional)</label>
            <input type="file" name="image" accept="image/*" class="w-full" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Deskripsi</label>
            <textarea name="description" class="w-full border rounded px-3 py-2" rows="3" placeholder="Deskripsi"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-2">
            <button type="reset" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 btn">Reset</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 btn">Simpan</button>
          </div>
        </form>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" data-list></div>
      </section>

      <section id="panel-education" data-collection="education">
        <h2 class="text-2xl font-semibold mb-3">Kelola Ruang Murid</h2>
        <p class="text-gray-600 mb-4">Sumber belajar (artikel/video/e-book/kursus).</p>
        <form class="bg-white p-4 rounded-lg shadow mb-4 grid md:grid-cols-2 gap-4" data-form>
          <div>
            <label class="block text-sm font-medium mb-1">Judul</label>
            <input type="text" name="title" class="w-full border rounded px-3 py-2" placeholder="Judul" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Tipe</label>
            <select name="type" class="w-full border rounded px-3 py-2">
              <option value="Artikel">Artikel</option>
              <option value="Video">Video</option>
              <option value="E-Book">E-Book</option>
              <option value="Kursus">Kursus</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Gambar (opsional)</label>
            <input type="file" name="image" accept="image/*" class="w-full" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Deskripsi</label>
            <textarea name="description" class="w-full border rounded px-3 py-2" rows="3" placeholder="Deskripsi"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-2">
            <button type="reset" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 btn">Reset</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 btn">Simpan</button>
          </div>
        </form>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" data-list></div>
      </section>

      <section id="panel-tahfidz" data-collection="tahfidz">
        <h2 class="text-2xl font-semibold mb-3">Kelola Tahfidz</h2>
        <p class="text-gray-600 mb-4">Catatan tahfidz (judul, deskripsi, gambar opsional).</p>
        <form class="bg-white p-4 rounded-lg shadow mb-4 grid md:grid-cols-2 gap-4" data-form>
          <div>
            <label class="block text-sm font-medium mb-1">Judul</label>
            <input type="text" name="title" class="w-full border rounded px-3 py-2" placeholder="Judul" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Gambar (opsional)</label>
            <input type="file" name="image" accept="image/*" class="w-full" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Deskripsi</label>
            <textarea name="description" class="w-full border rounded px-3 py-2" rows="3" placeholder="Deskripsi"></textarea>
          </div>
          <div class="md:col-span-2 flex justify-end gap-2">
            <button type="reset" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 btn">Reset</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 btn">Simpan</button>
          </div>
        </form>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" data-list></div>
      </section>
    </div>
  </main>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAXXHemBnW-jhYsOjKWFV31VP6PxlMF_Uc",
      authDomain: "diary-5b636.firebaseapp.com",
      projectId: "diary-5b636",
      storageBucket: "diary-5b636.firebasestorage.app",
      messagingSenderId: "1097902186066",
      appId: "1:1097902186066:web:904f534ea8ae6c3d05498b",
      measurementId: "G-JCCJLW0XD2",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // Stabilkan koneksi Firestore pada lingkungan jaringan/hosting terbatas
    try { db.settings({ experimentalAutoDetectLongPolling: true }); } catch(e) { console.warn('db.settings skipped', e); }
    const storage = firebase.storage();

    // Tab behavior
    const tabs = document.getElementById('tabs');
    const panels = document.querySelectorAll('[id^="panel-"]');

    tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-tab]');
      if (!btn) return;
      // toggle active
      tabs.querySelectorAll('button').forEach(b => b.classList.remove('tab-active'));
      btn.classList.add('tab-active');
      const tab = btn.dataset.tab;
      panels.forEach(p => {
        p.classList.toggle('hidden', p.id !== `panel-${tab}`);
      });
    });

    // Initialize visibility
    panels.forEach(p => p.classList.add('hidden'));
    document.getElementById('panel-photos').classList.remove('hidden');

    // Utility upload
    async function uploadFile(file, collection, docId) {
      const path = `${collection}/${docId}/${Date.now()}_${file.name}`;
      const ref = storage.ref().child(path);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      return { url, path };
    }

    // Render list for a collection panel
    async function renderList(panel) {
      const collection = panel.dataset.collection;
      const listEl = panel.querySelector('[data-list]');
      listEl.innerHTML = '<div class="text-gray-500">Memuat...</div>';
      try {
        const snap = await db.collection(collection).orderBy('createdAt','desc').get();
        if (snap.empty) {
          listEl.innerHTML = '<div class="text-gray-500">Belum ada data.</div>';
          return;
        }
        listEl.innerHTML = '';
        snap.forEach(doc => {
          const d = doc.data();
          const card = document.createElement('div');
          card.className = 'card bg-white rounded-lg shadow p-4 flex flex-col';
          card.innerHTML = `
            <div class="flex items-start gap-3">
              ${d.imageUrl ? `<img src="${d.imageUrl}" alt="" class="w-20 h-20 object-cover rounded">` : ''}
              <div class="flex-1">
                <h3 class="font-semibold">${d.title || '(Tanpa Judul)'}</h3>
                ${d.type ? `<div class="text-xs text-gray-500 mt-0.5">Tipe: ${d.type}</div>` : ''}
                ${d.date ? `<div class="text-xs text-gray-500 mt-0.5">Tanggal: ${d.date}</div>` : ''}
                ${d.description ? `<p class="text-sm text-gray-600 mt-1">${d.description}</p>` : ''}
              </div>
            </div>
            <div class="mt-3 flex justify-end">
              <button class="px-3 py-1.5 rounded bg-red-600 text-white hover:bg-red-700 btn" data-delete="${doc.id}">Hapus</button>
            </div>
          `;
          // bind delete
          card.querySelector('[data-delete]').addEventListener('click', async () => {
            if (!confirm('Yakin hapus item ini?')) return;
            // delete storage file first if any
            try {
              if (d.storagePath) {
                await storage.ref().child(d.storagePath).delete();
              }
            } catch (err) {
              console.warn('Gagal hapus file storage (lanjut hapus doc):', err);
            }
            await db.collection(collection).doc(doc.id).delete();
            renderList(panel);
          });
          listEl.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        listEl.innerHTML = '<div class="text-red-600">Gagal memuat data.</div>';
      }
    }

    // Bind all forms
    panels.forEach(panel => {
      const form = panel.querySelector('[data-form]');
      const collection = panel.dataset.collection;
      if (!form) return;

      // Initial render
      renderList(panel);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const title = fd.get('title')?.toString().trim() || '';
        const description = fd.get('description')?.toString().trim() || '';
        const type = fd.get('type')?.toString().trim() || '';
        const date = fd.get('date')?.toString() || '';
        const image = fd.get('image');
        if (!title) { alert('Judul wajib diisi'); return; }

        const base = {
          title,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        };
        // tambahkan field opsional hanya jika terisi
        if (description) base.description = description;
        if (type) base.type = type;
        if (date) base.date = date;

        try {
          // create doc first to get id
          const docRef = await db.collection(collection).add(base);
          let updates = {};
          if (image && image.size) {
            const { url, path } = await uploadFile(image, collection, docRef.id);
            updates.imageUrl = url;
            updates.storagePath = path;
          }
          if (Object.keys(updates).length) {
            updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
            await docRef.update(updates);
          }
          form.reset();
          renderList(panel);
        } catch (err) {
          console.error(err);
          alert('Gagal menyimpan. Coba lagi.');
        }
      });
    });
  </script>
</body>
</html>